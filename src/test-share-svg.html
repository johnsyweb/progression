<!DOCTYPE html>
<html>
<head>
  <title>Test Share SVG Generation</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .test-section {
      margin: 40px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .test-section h2 {
      margin-top: 0;
    }
    .svg-container {
      margin: 20px 0;
      border: 1px solid #ccc;
      padding: 10px;
      background: white;
    }
    .svg-container img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .info {
      margin: 10px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Test Share SVG Generation</h1>
  
  <div class="test-section">
    <h2>Service Worker Status</h2>
    <div id="sw-status" class="status info">Checking service worker...</div>
    <button onclick="checkServiceWorker()">Check Service Worker</button>
  </div>

  <div class="test-section">
    <h2>Test 1: /progression/2026-01-01/2026-12-31/2026</h2>
    <div class="info">
      <strong>Expected:</strong> SVG showing progress for year 2026, title "2026"
    </div>
    <button onclick="testPath1()">Generate SVG</button>
    <div id="result1"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: /progression/2020-01-01/2029-12-31/2020s</h2>
    <div class="info">
      <strong>Expected:</strong> SVG showing progress for 2020s decade, title "2020s"
    </div>
    <button onclick="testPath2()">Generate SVG</button>
    <div id="result2"></div>
  </div>

  <div class="test-section">
    <h2>Compare SVGs</h2>
    <button onclick="compareSVGs()">Generate Both and Compare</button>
    <div id="comparison"></div>
  </div>

  <script>
    const basePath = '/progression';
    
    function updateStatus(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
    }

    async function checkServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        updateStatus('sw-status', 'Service Worker not supported', 'error');
        return;
      }

      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        if (registrations.length === 0) {
          updateStatus('sw-status', 'No service worker registered. Please register it first.', 'error');
          return;
        }

        const reg = registrations[0];
        updateStatus('sw-status', `Service Worker active! Scope: ${reg.scope}, State: ${reg.active?.state || 'unknown'}`, 'success');
      } catch (error) {
        updateStatus('sw-status', `Error: ${error.message}`, 'error');
      }
    }

    async function testSVG(path, resultElementId) {
      const resultDiv = document.getElementById(resultElementId);
      resultDiv.innerHTML = '<div class="status info">Fetching SVG...</div>';

      try {
        // Construct the image URL as the share function would
        const imageUrl = `${basePath}/og-image.svg?path=${encodeURIComponent(path)}`;
        console.log('Fetching:', imageUrl);

        const response = await fetch(imageUrl);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);

        const blob = await response.blob();
        const text = await blob.text();

        // Verify it's SVG
        if (!text.includes('<svg') || !contentType?.includes('svg')) {
          throw new Error('Response is not SVG');
        }

        // Create object URL for display
        const objectUrl = URL.createObjectURL(blob);

        // Extract key info from SVG
        const titleMatch = text.match(/<text[^>]*>([^<]+)<\/text>/);
        const percentageMatch = text.match(/(\d+\.\d+)%/);
        const hasProgressBar = text.includes('<rect') && text.includes('1200') && text.includes('630');

        const info = `
          <div class="status success">✅ SVG Generated Successfully!</div>
          <div class="info">
            <strong>Title:</strong> ${titleMatch ? titleMatch[1] : 'Not found'}<br>
            <strong>Percentage:</strong> ${percentageMatch ? percentageMatch[0] : 'Not found'}<br>
            <strong>Has Progress Bar:</strong> ${hasProgressBar ? 'Yes' : 'No'}<br>
            <strong>Size:</strong> ${blob.size} bytes
          </div>
          <div class="svg-container">
            <img src="${objectUrl}" alt="Generated SVG" />
          </div>
          <details>
            <summary>View SVG Source</summary>
            <pre>${text.substring(0, 500)}...</pre>
          </details>
        `;

        resultDiv.innerHTML = info;
      } catch (error) {
        console.error('Error generating SVG:', error);
        resultDiv.innerHTML = `
          <div class="status error">❌ Error: ${error.message}</div>
          <pre>${error.stack}</pre>
        `;
      }
    }

    function testPath1() {
      const path = '/progression/2026-01-01/2026-12-31/2026';
      testSVG(path, 'result1');
    }

    function testPath2() {
      const path = '/progression/2020-01-01/2029-12-31/2020s';
      testSVG(path, 'result2');
    }

    async function compareSVGs() {
      const comparisonDiv = document.getElementById('comparison');
      comparisonDiv.innerHTML = '<div class="status info">Generating both SVGs...</div>';

      try {
        const path1 = '/progression/2026-01-01/2026-12-31/2026';
        const path2 = '/progression/2020-01-01/2029-12-31/2020s';

        const [response1, response2] = await Promise.all([
          fetch(`${basePath}/og-image.svg?path=${encodeURIComponent(path1)}`),
          fetch(`${basePath}/og-image.svg?path=${encodeURIComponent(path2)}`)
        ]);

        if (!response1.ok || !response2.ok) {
          throw new Error('Failed to fetch one or both SVGs');
        }

        const [text1, text2] = await Promise.all([
          response1.text(),
          response2.text()
        ]);

        const title1 = text1.match(/<text[^>]*>([^<]+)<\/text>/)?.[1] || 'Not found';
        const title2 = text2.match(/<text[^>]*>([^<]+)<\/text>/)?.[1] || 'Not found';

        const areDifferent = text1 !== text2;
        const title1Correct = title1.includes('2026');
        const title2Correct = title2.includes('2020s');

        const comparison = `
          <div class="status ${areDifferent && title1Correct && title2Correct ? 'success' : 'error'}">
            ${areDifferent && title1Correct && title2Correct 
              ? '✅ SVGs are different and have correct titles!' 
              : '❌ SVGs may be identical or have incorrect titles'}
          </div>
          <div class="info">
            <strong>SVG 1 Title:</strong> ${title1} ${title1Correct ? '✅' : '❌'}<br>
            <strong>SVG 2 Title:</strong> ${title2} ${title2Correct ? '✅' : '❌'}<br>
            <strong>Are Different:</strong> ${areDifferent ? 'Yes ✅' : 'No ❌'}
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="svg-container">
              <h3>SVG 1: 2026</h3>
              <img src="${URL.createObjectURL(new Blob([text1], { type: 'image/svg+xml' }))}" alt="SVG 1" />
            </div>
            <div class="svg-container">
              <h3>SVG 2: 2020s</h3>
              <img src="${URL.createObjectURL(new Blob([text2], { type: 'image/svg+xml' }))}" alt="SVG 2" />
            </div>
          </div>
        `;

        comparisonDiv.innerHTML = comparison;
      } catch (error) {
        comparisonDiv.innerHTML = `
          <div class="status error">❌ Error: ${error.message}</div>
        `;
      }
    }

    // Check service worker on load
    window.addEventListener('load', checkServiceWorker);
  </script>
</body>
</html>
