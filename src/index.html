<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="theme-color"
      content="#fafafa"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#121212"
      media="(prefers-color-scheme: dark)"
    />
    <title>Progress | johnsy.com</title>
    <link rel="stylesheet" href="style.css" />
    <meta property="og:title" content="Progress | johnsy.com" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="" />
    <meta property="og:description" content="" />
    <meta property="og:image" content="" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="" />
    <script>
      (function () {
        const path = window.location.pathname;
        const baseUrl = window.location.origin;
        const baseTag = document.querySelector("base");
        let basePath = "/";
        if (baseTag && baseTag.href) {
          try {
            const baseUrlObj = new URL(baseTag.href);
            basePath = baseUrlObj.pathname.endsWith("/")
              ? baseUrlObj.pathname.slice(0, -1)
              : baseUrlObj.pathname;
          } catch {
            basePath = "/";
          }
        }
        const ogUrl = baseUrl + (path === "/" ? "" : path);

        // Extract title from path
        let title = "Progress";
        let strippedPath = path;
        if (basePath !== "/" && path.startsWith(basePath)) {
          strippedPath = path.slice(basePath.length) || "/";
        }
        const parts = strippedPath.split("/").filter((part) => part.length > 0);
        if (parts.length >= 3) {
          title = decodeURIComponent(parts.slice(2).join("/"));
        } else if (parts.length === 2) {
          // If only dates, use current year as title
          const currentYear = new Date().getFullYear();
          title = currentYear.toString();
        }

        // Use SVG images generated server-side
        const normalizedBasePath = basePath === "/" ? "" : basePath.replace(/\/$/, "");
        const ogImagePath = normalizedBasePath === "" ? "/og-image.svg" : `${normalizedBasePath}/og-image.svg`;
        const ogImageUrl =
          path && path !== "/" && path !== basePath
            ? baseUrl + ogImagePath + "?path=" + encodeURIComponent(path)
            : baseUrl + ogImagePath + "?path=" + encodeURIComponent(path);

        const ogTitleMeta = document.querySelector('meta[property="og:title"]');
        if (ogTitleMeta) {
          ogTitleMeta.setAttribute("content", `${title} | johnsy.com`);
        }

        const ogImageMeta = document.querySelector('meta[property="og:image"]');
        if (ogImageMeta) {
          ogImageMeta.setAttribute("content", ogImageUrl);
        }

        const ogUrlMeta = document.querySelector('meta[property="og:url"]');
        if (ogUrlMeta) {
          ogUrlMeta.setAttribute("content", ogUrl);
        }

        const twitterImageMeta = document.querySelector(
          'meta[name="twitter:image"]'
        );
        if (twitterImageMeta) {
          twitterImageMeta.setAttribute("content", ogImageUrl);
        }

        // Set description based on path
        // Parse dates from path to calculate status
        let description = "";
        if (parts.length >= 2) {
          try {
            const startDate = new Date(parts[0]);
            const endDate = new Date(parts[1]);
            const current = new Date();
            
            if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
              const totalMs = endDate.getTime() - startDate.getTime();
              const elapsedMs = current.getTime() - startDate.getTime();
              const totalDays = Math.round(totalMs / (1000 * 60 * 60 * 24));
              const elapsedDays = Math.round(elapsedMs / (1000 * 60 * 60 * 24));
              const remainingDays = totalDays - elapsedDays;
              
              let percentage = null;
              if (current >= startDate && current <= endDate) {
                percentage = (elapsedMs / totalMs) * 100;
              }
              
              if (percentage !== null) {
                description = `${percentage.toFixed(1)}% complete • ${elapsedDays} days elapsed • ${remainingDays} days remaining`;
              } else if (current < startDate) {
                const daysUntilStart = Math.round((startDate.getTime() - current.getTime()) / (1000 * 60 * 60 * 24));
                description = `Starting in ${daysUntilStart} day${daysUntilStart !== 1 ? "s" : ""}`;
              } else {
                const daysSinceEnd = Math.round((current.getTime() - endDate.getTime()) / (1000 * 60 * 60 * 24));
                description = `Completed ${daysSinceEnd} day${daysSinceEnd !== 1 ? "s" : ""} ago`;
              }
            }
          } catch (e) {
            // Ignore errors
          }
        }
        
        const ogDescriptionMeta = document.querySelector(
          'meta[property="og:description"]'
        );
        if (ogDescriptionMeta && description) {
          ogDescriptionMeta.setAttribute("content", description);
        }
      })();
    </script>
  </head>
  <body>
    <div id="page">
      <header id="header">
        <h1><a href="https://johnsy.com/">johnsy.com</a></h1>
      </header>

      <main id="content" role="main">
        <div id="progress-container"></div>
      </main>

      <div id="accesskeys" class="accesskeys">
        <p class="accesskeys-title">Keyboard shortcuts:</p>
        <ul class="accesskeys-list" id="accesskeys-list">
          <li>
            <kbd id="accesskey-title"
              ><span class="modifier-key">Alt</span>+T</kbd
            >
            Edit title
          </li>
          <li>
            <kbd id="accesskey-start"
              ><span class="modifier-key">Alt</span>+S</kbd
            >
            Edit start date
          </li>
          <li>
            <kbd id="accesskey-end"
              ><span class="modifier-key">Alt</span>+E</kbd
            >
            Edit end date
          </li>
          <li>
            <kbd id="accesskey-share"
              ><span class="modifier-key">Alt</span>+H</kbd
            >
            Share progress
          </li>
        </ul>
      </div>

      <div id="service-worker-status" class="service-worker-status" role="status" aria-live="polite">
        <span class="service-worker-status-label">Service Worker:</span>
        <span class="service-worker-status-value" id="service-worker-status-value">Checking...</span>
      </div>

      <footer id="footer">
        <p>
          Copyright &copy; 2000-<span id="current-year"></span>
          <a rel="author" href="https://johnsy.com/about/"
            ><em><acronym title="Peter Alexander Johns">paj</acronym></em></a
          >
          (<a
            rel="me"
            aria-label="@pete.johnsy.com on Bluesky"
            href="https://bsky.app/profile/pete.johnsy.com"
            >@pete.johnsy.com</a
          >) All rights (and some wrongs) reserved.
        </p>
      </footer>
    </div>

    <script type="module" src="/main.ts"></script>
    <script>
      document.getElementById("current-year").textContent =
        new Date().getFullYear();
    </script>
  </body>
</html>
